#!/usr/bin/env python3
"""Docker CLI plugin to list images grouped by registry and repository."""

import re
import subprocess
import sys
from collections import defaultdict
from pathlib import Path

# ANSI color codes
CYAN = "\033[1;36m"
BOLD = "\033[1m"
RESET = "\033[0m"


def handle_metadata():
    """Handle Docker CLI plugin metadata requests."""
    plugin_name = Path(sys.argv[0]).stem

    if "--help" in sys.argv or "-h" in sys.argv:
        print(f"Usage: docker {plugin_name} [OPTIONS]")
        print("\nList Docker images grouped by registry and repository")
        sys.exit(0)

    if sys.argv[1:2] == ["docker-cli-plugin-metadata"]:
        metadata = {
            "SchemaVersion": "0.1.0",
            "Vendor": "Custom",
            "Version": "1.0.0",
            "ShortDescription": "List Docker images grouped by registry and repository",
        }
        import json

        print(json.dumps(metadata))
        sys.exit(0)


def extract_registry(repo):
    """Extract the registry domain from a repository name."""
    # Has domain with dots (e.g., ghcr.io/user/repo or docker.io/library/nginx)
    if match := re.match(r"^([^/]+\.[^/]+)/", repo):
        return match.group(1)

    # Three-part without dots (e.g., registry/user/repo)
    if re.match(r"^([^/]+)/([^/]+)/.+$", repo):
        return repo.split("/")[0]

    # No domain = Docker Hub official (e.g., nginx, postgres)
    return "docker.io"


def get_repositories():
    """Get all unique repositories from Docker images."""
    result = subprocess.run(
        ["docker", "image", "ls", "--format", "{{.Repository}}"],
        capture_output=True,
        text=True,
        check=True,
    )
    return sorted(set(result.stdout.strip().split("\n")))


def get_images_for_repo(repo):
    """Get all images for a specific repository."""
    result = subprocess.run(
        ["docker", "image", "ls", repo, "--format", "{{.ID}}\t{{.Size}}\t{{.Tag}}"],
        capture_output=True,
        text=True,
        check=True,
    )

    images = []
    for line in result.stdout.strip().split("\n"):
        if line:
            parts = line.split("\t")
            if len(parts) == 3:
                images.append({"id": parts[0], "size": parts[1], "tag": parts[2]})
    return images


def main():
    """Main function to list images grouped by registry."""
    handle_metadata()

    # Skip plugin name if passed as first argument
    args = sys.argv[1:]
    if args and args[0] in ["img", "docker-img"]:
        args = args[1:]

    try:
        # Group repositories by registry
        registry_repos = defaultdict(list)
        for repo in get_repositories():
            registry = extract_registry(repo)
            registry_repos[registry].append(repo)

        # Display grouped images
        for registry in sorted(registry_repos.keys()):
            # Print registry header
            print(f"\n{CYAN}{registry}{RESET}")
            print("=" * len(registry))

            for repo in registry_repos[registry]:
                # Print repository name
                print(f"\n  {BOLD}{repo}:{RESET}")

                # Print images for this repository
                images = get_images_for_repo(repo)
                for img in images:
                    print(f"    {img['id']:<12} {img['size']:<10} {img['tag']}")

        print()  # Final newline

    except subprocess.CalledProcessError as e:
        print(f"Error running docker command: {e}", file=sys.stderr)
        sys.exit(1)
    except KeyboardInterrupt:
        print("\nInterrupted", file=sys.stderr)
        sys.exit(130)


if __name__ == "__main__":
    main()
