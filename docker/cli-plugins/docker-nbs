#!/usr/bin/env python3
"""
Docker CLI plugin to bootstrap networks from config file
"""

import argparse
import sys
from pathlib import Path

import tomllib

try:
    import cli_helper as cli
except ImportError:
    import os

    sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))
    import cli_helper as cli

PLUGIN_METADATA = {
    "SchemaVersion": "0.1.0",
    "Vendor": "delfianto",
    "Version": "1.0.0",
    "ShortDescription": "Bootstrap Docker networks from config file",
}


def create_network(name, config, dry_run=False):
    """Create a single Docker network"""
    cmd = ["network", "create"]
    cmd.extend(["--driver", config.get("driver", "bridge")])

    if config.get("internal", False):
        cmd.append("--internal")

    if "subnet" in config:
        cmd.extend(["--subnet", config["subnet"]])

    if "gateway" in config:
        cmd.extend(["--gateway", config["gateway"]])

    labels = config.get("labels", {})
    for key, value in labels.items():
        cmd.extend(["--label", f"{key}={value}"])

    cmd.append(name)

    if dry_run:
        print(f"[DRY RUN] Would execute: docker {' '.join(cmd)}")
        return True

    result = cli.run_docker_command(cmd, check=False)
    if result.returncode == 0:
        cli.print_success(f"✓ Created: {name}")
        return True
    elif "already exists" in result.stderr:
        cli.print_warning(f"⊘ Already exists: {name}")
        return True
    else:
        cli.print_error(f"✗ Failed: {name}")
        print(f"  Error: {result.stderr.strip()}", file=sys.stderr)
        return False


def bootstrap_networks(config_path, dry_run=False):
    """Bootstrap all networks from config file"""
    config_file = Path(config_path)
    if not config_file.exists():
        cli.print_error(f"Config file not found: {config_path}")
        return 1

    try:
        with open(config_file, "rb") as f:
            if config_file.suffix in [".toml"]:
                config = tomllib.load(f)
            else:
                cli.print_error(f"Unsupported file format: {config_file.suffix}")
                return 1
    except Exception as e:
        cli.print_error(f"Error parsing config file: {e}")
        return 1

    networks = config.get("networks", {})
    if not networks:
        cli.print_error("No networks defined in config")
        return 1

    if dry_run:
        print(f"[DRY RUN] Would bootstrap {len(networks)} network(s)...\n")
    else:
        print(f"Bootstrapping {len(networks)} network(s)...\n")

    success_count = 0
    for name, net_config in networks.items():
        if create_network(name, net_config, dry_run):
            success_count += 1

    # Summary
    print(f"\n{'=' * 50}")
    cli.print_info(f"Summary: {success_count}/{len(networks)} networks ready")
    print(f"{'=' * 50}\n")

    if not dry_run:
        result = cli.run_docker_command(
            [
                "network",
                "ls",
                "--filter",
                "label=purpose",
                "--format",
                "table {{.Name}}\\t{{.Driver}}\\t{{.Scope}}\\t{{.Labels}}",
            ],
            check=False,
        )
        if result.returncode == 0:
            print(result.stdout)

    return 0 if success_count == len(networks) else 1


def main():
    # Handle plugin metadata
    cli.handle_metadata(PLUGIN_METADATA)

    # Setup argument parser
    parser = argparse.ArgumentParser(
        description="Bootstrap Docker networks from configuration file",
        prog="docker nbs",
    )
    parser.add_argument(
        "-f",
        "--file",
        default="./networks.toml",
        help="Path to config file (default: ./networks.toml)",
    )
    parser.add_argument(
        "--dry-run",
        action="store_true",
        help="Show what would be created without actually creating",
    )

    # Parse arguments using cli handler
    args = cli.parse_plugin_args(parser, ["nbs", "docker-nbs"])

    # Bootstrap networks
    return bootstrap_networks(args.file, args.dry_run)


if __name__ == "__main__":
    sys.exit(main())
