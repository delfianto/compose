#!/usr/bin/env python3
"""Docker CLI plugin to pretty print docker ps with multiple output formats."""

import argparse
import json
import subprocess
import sys
from dataclasses import dataclass
from typing import Optional

# ANSI color codes
RED = "\033[0;31m"
GREEN = "\033[0;32m"
YELLOW = "\033[1;33m"
BLUE = "\033[0;34m"
CYAN = "\033[1;36m"
NC = "\033[0m"  # No Color


@dataclass
class ContainerInfo:
    """Container information structure."""

    name: str
    id: str
    image: str
    status: str
    created: str
    running_for: str
    ports: str
    networks: str
    size: str
    command: str
    mounts: list[str]
    labels: dict[str, str]


def handle_metadata():
    """Handle Docker CLI plugin metadata requests."""

    if "docker-cli-plugin-metadata" in sys.argv:
        metadata = {
            "SchemaVersion": "0.1.0",
            "Vendor": "Custom",
            "Version": "1.0.0",
            "ShortDescription": "Pretty print docker ps with multiple output formats",
        }
        print(json.dumps(metadata))
        sys.exit(0)


def run_docker_command(args: list, check: bool = True) -> str:
    """Run a docker command and return output."""
    result = subprocess.run(
        ["docker"] + args, capture_output=True, text=True, check=check
    )
    return result.stdout.strip()


def get_container_command(container_id: str) -> str:
    """Get the full command for a container (handles both Cmd and Entrypoint)."""
    try:
        config_json = run_docker_command(
            ["inspect", "--format", "{{json .Config}}", container_id]
        )
        config = json.loads(config_json)

        # Prefer Cmd, fallback to Entrypoint
        if config.get("Cmd"):
            return " ".join(config["Cmd"])
        elif config.get("Entrypoint"):
            return " ".join(config["Entrypoint"])
        else:
            return "N/A"
    except (subprocess.CalledProcessError, json.JSONDecodeError, KeyError):
        return "N/A"


def get_container_mounts(container_id: str) -> list[str]:
    """Get container mounts as a sorted list."""
    try:
        mounts_json = run_docker_command(
            ["inspect", "--format", "{{json .Mounts}}", container_id]
        )
        mounts = json.loads(mounts_json)

        mount_list = []
        for mount in mounts:
            source = mount.get("Source", "")
            destination = mount.get("Destination", "")
            mode = mount.get("Mode", "")
            if source and destination:
                mount_list.append(f"{source}:{destination}:{mode}")

        return sorted(mount_list)
    except (subprocess.CalledProcessError, json.JSONDecodeError):
        return []


def get_container_labels(container_id: str) -> dict[str, str]:
    """Get container labels as a sorted dictionary."""
    try:
        labels_json = run_docker_command(
            ["inspect", "--format", "{{json .Config.Labels}}", container_id]
        )
        labels = json.loads(labels_json)
        return dict(sorted(labels.items())) if labels else {}
    except (subprocess.CalledProcessError, json.JSONDecodeError):
        return {}


def get_container_info(
    container_id: str, show_all: bool = True
) -> Optional[ContainerInfo]:
    """Get detailed information about a container."""
    all_flag = ["--all"] if show_all else []

    try:
        # Get basic info from docker ps
        ps_format = "{{.Names}}\t{{.ID}}\t{{.Image}}\t{{.Status}}\t{{.CreatedAt}}\t{{.RunningFor}}\t{{.Ports}}\t{{.Networks}}\t{{.Size}}"
        output = run_docker_command(
            ["ps"]
            + all_flag
            + ["--filter", f"id={container_id}", "--format", ps_format]
        )

        if not output:
            return None

        parts = output.split("\t")
        if len(parts) < 9:
            return None

        name, id_, image, status, created, running_for, ports, networks, size = parts

        # Get additional info
        command = get_container_command(container_id)
        mounts = get_container_mounts(container_id)
        labels = get_container_labels(container_id)

        return ContainerInfo(
            name=name,
            id=id_,
            image=image,
            status=status,
            created=created,
            running_for=running_for,
            ports=ports,
            networks=networks,
            size=size,
            command=command,
            mounts=mounts,
            labels=labels,
        )
    except subprocess.CalledProcessError:
        return None


def format_json_value(value: str, indent: int = 4) -> str:
    """Format a JSON string value with proper indentation and colors."""
    if not (value.startswith("{") or value.startswith("[")):
        return value

    try:
        obj = json.loads(value)
        formatted = json.dumps(obj, indent=2)
        # Add indentation to each line
        lines = formatted.split("\n")
        return "\n" + "\n".join(" " * indent + line for line in lines)
    except json.JSONDecodeError:
        return value


def print_container_detail(info: ContainerInfo):
    """Print detailed information about a container."""
    print(f"\n{CYAN}{'━' * 78}{NC}")
    print(f"{CYAN}Container Information:{NC}")
    print(f"  {GREEN}Name:{NC} {info.name}")
    print(f"  {YELLOW}ID:{NC} {info.id}")
    print(f"  {CYAN}Image:{NC} {info.image}")
    print(f"  {BLUE}Command:{NC} {info.command}")
    print(f"  {RED}Status:{NC} {info.status}")
    print(f"  {GREEN}Created:{NC} {info.created}")
    print(f"  {YELLOW}Running For:{NC} {info.running_for}")
    print(f"  {CYAN}Ports:{NC} {info.ports}")
    print(f"  {BLUE}Networks:{NC} {info.networks}")
    print(f"  {YELLOW}Size:{NC} {info.size}")

    # Print mounts
    if info.mounts:
        print(f"  {GREEN}Mounts:{NC}")
        for mount in info.mounts:
            print(f"    {GREEN}•{NC} {mount}")

    # Print labels
    if info.labels:
        print(f"  {CYAN}Labels:{NC}")
        for key, value in info.labels.items():
            # Check if value is JSON
            if value.startswith("{") or value.startswith("["):
                formatted_value = format_json_value(value, indent=6)
                print(f"    {CYAN}•{NC} {key}={formatted_value}")
            else:
                print(f"    {CYAN}•{NC} {key}={value}")


def show_brief_format(show_all: bool = True):
    """Display containers in brief table format."""
    all_flag = ["--all"] if show_all else []

    try:
        # Use docker's built-in table formatting
        result = subprocess.run(
            ["docker", "ps"]
            + all_flag
            + [
                "--format",
                "table {{.Names}}\t{{.ID}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}",
            ],
            check=True,
        )
        return result.returncode
    except subprocess.CalledProcessError as e:
        return e.returncode


def show_detail_format(container_name: Optional[str] = None, show_all: bool = True):
    """Display containers in verbose/detail format."""
    all_flag = ["--all"] if show_all else []

    try:
        if container_name:
            # Find container by name
            container_ids = run_docker_command(
                ["ps"]
                + all_flag
                + ["--filter", f"name={container_name}", "--format", "{{.ID}}"],
                check=False,
            ).split("\n")
            container_ids = [cid for cid in container_ids if cid]

            if not container_ids:
                print(
                    f"{RED}Error: No container found matching '{container_name}'{NC}",
                    file=sys.stderr,
                )
                return 1
        else:
            # Get all containers sorted by name
            output = run_docker_command(
                ["ps"] + all_flag + ["--format", "{{.Names}}\t{{.ID}}"]
            )

            if not output:
                print("No containers found")
                return 0

            # Sort by name and extract IDs
            lines = sorted(output.split("\n"))
            container_ids = [line.split("\t")[1] for line in lines if line]

        # Print details for each container
        for container_id in container_ids:
            info = get_container_info(container_id, show_all)
            if info:
                print_container_detail(info)

        print(f"{CYAN}{'━' * 78}{NC}\n")
        return 0

    except subprocess.CalledProcessError as e:
        print(f"{RED}Error running docker command: {e}{NC}", file=sys.stderr)
        return 1


def main():
    """Main function."""
    handle_metadata()

    # Parse arguments
    parser = argparse.ArgumentParser(
        description="Pretty print docker ps with multiple output formats",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  docker pps                    # Brief table format (all containers)
  docker pps -b                 # Same as above
  docker pps -v                 # Verbose format for all containers
  docker pps -v mycontainer     # Verbose format for specific container
  docker pps --running          # Show only running containers
        """,
    )

    output_group = parser.add_mutually_exclusive_group()
    output_group.add_argument(
        "-b", "--brief", action="store_true", help="Brief table format (default)"
    )
    output_group.add_argument(
        "-v", "--verbose", action="store_true", help="Verbose detailed format"
    )

    parser.add_argument(
        "--running",
        action="store_true",
        help="Show only running containers (exclude stopped ones)",
    )

    parser.add_argument(
        "container", nargs="?", help="Container name to filter (only with -v/--verbose)"
    )

    # Skip plugin name if passed as first argument
    args_to_parse = sys.argv[1:]
    if args_to_parse and args_to_parse[0] in ["pps", "docker-pps"]:
        args_to_parse = args_to_parse[1:]

    args = parser.parse_args(args_to_parse)

    # Determine if we should show all containers
    show_all = not args.running

    # Default to brief format
    if not args.verbose:
        return show_brief_format(show_all)
    else:
        # Verbose format
        if args.container and not args.verbose:
            print(
                f"{RED}Error: Container name can only be specified with -v/--verbose{NC}",
                file=sys.stderr,
            )
            print("Use 'docker pps --help' for usage information", file=sys.stderr)
            return 1

        return show_detail_format(args.container, show_all)


if __name__ == "__main__":
    sys.exit(main())
