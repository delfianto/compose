#!/usr/bin/env python3
"""Docker CLI plugin to check NVIDIA GPU availability and run nvidia-smi."""

import json
import shutil
import subprocess
import sys

# ANSI color codes
RED = "\033[0;31m"
GREEN = "\033[0;32m"
YELLOW = "\033[1;33m"
BLUE = "\033[0;34m"
CYAN = "\033[1;36m"
NC = "\033[0m"  # No Color


def handle_metadata():
    """Handle Docker CLI plugin metadata requests."""

    if "docker-cli-plugin-metadata" in sys.argv:
        metadata = {
            "SchemaVersion": "0.1.0",
            "Vendor": "Custom",
            "Version": "1.0.0",
            "ShortDescription": "Check NVIDIA GPU availability and run nvidia-smi",
        }
        print(json.dumps(metadata))
        sys.exit(0)


def check_docker_daemon() -> bool:
    """Check if Docker daemon is accessible."""
    print(f"{YELLOW}[1/3]{NC} Checking Docker daemon...")

    try:
        subprocess.run(["docker", "info"], capture_output=True, check=True, timeout=5)
        print(f"{GREEN}✓ Docker daemon is running{NC}\n")
        return True
    except (
        subprocess.CalledProcessError,
        subprocess.TimeoutExpired,
        FileNotFoundError,
    ):
        print(f"{RED}✗ Docker daemon is not accessible{NC}")
        return False


def check_nvidia_toolkit() -> bool:
    """Check if NVIDIA Container Toolkit is installed and configured."""
    print(f"{YELLOW}[2/3]{NC} Checking NVIDIA Container Toolkit...")

    runtime_detected = False
    toolkit_installed = False
    runtime_installed = False

    # Method 1: Check for nvidia runtime in docker info
    try:
        result = subprocess.run(
            ["docker", "info"], capture_output=True, text=True, check=True, timeout=5
        )
        if "nvidia" in result.stdout.lower():
            print(f"{GREEN}✓ NVIDIA runtime detected in Docker runtimes{NC}")
            runtime_detected = True
    except (subprocess.CalledProcessError, subprocess.TimeoutExpired):
        pass

    # Method 2: Check if nvidia-container-toolkit is installed
    if shutil.which("nvidia-container-toolkit"):
        print(f"{GREEN}✓ nvidia-container-toolkit binary found{NC}")
        toolkit_installed = True

    # Method 3: Check for nvidia-container-runtime
    if shutil.which("nvidia-container-runtime"):
        print(f"{GREEN}✓ nvidia-container-runtime found{NC}")
        runtime_installed = True

    # If none of the checks passed
    if not (runtime_detected or toolkit_installed or runtime_installed):
        print(f"{RED}✗ NVIDIA Container Toolkit not detected{NC}")
        print(
            f"{YELLOW}Install it from: https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html{NC}\n"
        )
        return False

    print()
    return True


def test_gpu_availability(
    cuda_image: str = "nvidia/cuda:13.0.2-base-ubuntu24.04",
) -> bool:
    """Test GPU availability by running nvidia-smi in a container."""
    print(f"{YELLOW}[3/3]{NC} Testing GPU availability with NVIDIA CUDA container...")

    command = ["docker", "run", "--rm", "--gpus", "all", cuda_image, "nvidia-smi"]
    print(f"{BLUE}Running: {' '.join(command)}{NC}\n")

    try:
        subprocess.run(
            command,
            check=True,
            timeout=120,
        )

        print(f"\n{GREEN}✓ GPU detection successful!{NC}")
        return True

    except subprocess.CalledProcessError:
        print(f"\n{RED}✗ Failed to access GPUs in container{NC}")
        print(f"{YELLOW}Troubleshooting tips:{NC}")
        print("  1. Ensure NVIDIA drivers are installed on the host")
        print("  2. Verify nvidia-container-toolkit is properly configured")
        print("  3. Try: sudo systemctl restart docker")
        print("  4. Check Docker daemon configuration in /etc/docker/daemon.json")
        return False

    except subprocess.TimeoutExpired:
        print(f"\n{RED}✗ Timeout waiting for container to start{NC}")
        print(f"{YELLOW}This might be caused by:{NC}")
        print("  1. Slow network connection (downloading CUDA image)")
        print("  2. System resource constraints")
        print("  3. Docker daemon issues")
        return False

    except FileNotFoundError:
        print(f"\n{RED}✗ Docker command not found{NC}")
        return False


def main():
    """Main function."""
    handle_metadata()

    # Skip plugin name if passed as first argument
    args = sys.argv[1:]
    if args and args[0] in ["smi", "docker-smi"]:
        args = args[1:]

    print(f"{BLUE}=== Docker SMI - NVIDIA GPU Checker ==={NC}\n")

    # Step 1: Check Docker daemon
    if not check_docker_daemon():
        return 1

    # Step 2: Check NVIDIA Container Toolkit
    if not check_nvidia_toolkit():
        return 1

    # Step 3: Test GPU availability
    if not test_gpu_availability():
        return 1

    return 0


if __name__ == "__main__":
    sys.exit(main())
