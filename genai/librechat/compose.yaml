services:
  librechat:
    container_name: chat-api
    image: ghcr.io/danny-avila/librechat-dev:latest
    user: ${UID}:${GID}
    userns_mode: host
    networks:
      - database
      - genai
      - proxy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    env_file:
      - librechat.env
      - librechat.env.local
      - postgres.env
      - postgres.env.local
    volumes:
      - ${PROJ_DIR}/.env:/app/.env
      - ${DATA_DIR}/config.yaml:/app/librechat.yaml
      - ${DATA_DIR}/images:/app/client/public/images
      - ${DATA_DIR}/uploads:/app/uploads
      - ${DATA_DIR}/logs:/app/logs
    labels:
      # Traefik integration
      - "traefik.enable=true"
      - "traefik.http.routers.chat.entrypoints=websecure"
      - "traefik.http.routers.chat.rule=Host(`chat.${TRAEFIK_ACME_DOMAIN}`)"
      - "traefik.http.routers.chat.tls.certresolver=cloudflare"
      - "traefik.http.services.chat.loadbalancer.server.port=${PORT}"
      # Homepage integration
      - "homepage.group=Artificial Intelligence"
      - "homepage.name=LibreChat"
      - "homepage.icon=librechat.svg"
      - "homepage.href=https://chat.${TRAEFIK_ACME_DOMAIN}"

  meilisearch:
    container_name: chat-search
    image: getmeili/meilisearch:v1.25.0
    restart: on-failure:3
    user: ${UID}:${GID}
    userns_mode: host
    environment:
      - MEILI_HOST=http://meilisearch:7700
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY}
      - MEILI_NO_ANALYTICS=true
    volumes:
      - ${DATA_DIR}/meili:/meili_data
    networks:
      - genai
    env_file:
      - .env
      - .env.local

  rag:
    container_name: chat-rag
    image: ghcr.io/danny-avila/librechat-rag-api-dev-lite:latest
    user: ${UID}:${GID}
    userns_mode: host
    environment:
      - DB_HOST=vectordb
      - POSTGRES_DB=librechat
      - POSTGRES_USER=chat
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - RAG_PORT=${RAG_PORT:-8000}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    networks:
      - database
      - genai
    env_file:
      - .env
      - .env.local

networks:
  database:
    external: true
  genai:
    external: true
  proxy:
    external: true
