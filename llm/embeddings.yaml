services:
  tei-semantic-cache:
    image: ghcr.io/huggingface/text-embeddings-inference:${HF_TEI_TAG}
    container_name: litellm-cache
    networks:
      - llm
      - proxy
    environment:
      - NVIDIA_VISIBLE_DEVICES=${SEMANTIC_GPU}
      - MAX_CLIENT_BATCH_SIZE=${SEMANTIC_CACHE_CLIENT_BATCH}
    volumes:
      - ${DATA_DIR}/tei:/data
    command:
      - --hostname=0.0.0.0
      - --port=4000
      - --hf-token=${HF_TOKEN}
      - --model-id=${SEMANTIC_CACHE_MODEL}
      - --dtype=${TEI_EMBEDDER_DTYPE}
      - --max-batch-tokens=${TEI_EMBEDDER_BATCH}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  tei-embedder:
    image: ghcr.io/huggingface/text-embeddings-inference:${HF_TEI_TAG}
    container_name: rag-embedder
    networks:
      - llm
      - proxy
    volumes:
      - ${DATA_DIR}/tei:/data
    environment:
      - NVIDIA_VISIBLE_DEVICES=${EMBEDDING_GPU}
      - MAX_CLIENT_BATCH_SIZE=${TEI_EMBEDDER_CLIENT_BATCH}
    command:
      - --hostname=0.0.0.0
      - --port=4000
      - --hf-token=${HF_TOKEN}
      - --model-id=${RAG_EMBEDDING_MODEL}
      - --dtype=${TEI_EMBEDDER_DTYPE}
      - --max-batch-tokens=${TEI_EMBEDDER_BATCH}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  tei-reranker:
    image: ghcr.io/huggingface/text-embeddings-inference:${HF_TEI_TAG}
    container_name: rag-reranker
    networks:
      - llm
      - proxy
    volumes:
      - ${DATA_DIR}/tei:/data
    environment:
      - NVIDIA_VISIBLE_DEVICES=${RERANKING_GPU}
      - MAX_CLIENT_BATCH_SIZE=${TEI_RERANKER_CLIENT_BATCH}
    command:
      - --hostname=0.0.0.0
      - --port=4000
      - --hf-token=${HF_TOKEN}
      - --model-id=${RAG_RERANKING_MODEL}
      - --dtype=${TEI_RERANKER_DTYPE}
      - --max-batch-tokens=${TEI_RERANKER_BATCH}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  tei-proxy:
    image: ${TEI_PROXY_IMG}
    container_name: rag-proxy
    networks:
      - llm
      - proxy
    environment:
      - MAX_CLIENT_BATCH_SIZE=${TEI_RERANKER_CLIENT_BATCH}
      - TEI_ENDPOINT=${TEI_RERANKER_BASE_URL}
      - TEI_PROXY_PORT=${TEI_PROXY_PORT}
      - RUST_LOG=${TEI_PROXY_LOG}
